# Allgemeine Proxy-Settings
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# ---------------------------
# Nextcloud AIO (nach Setup zeigt AIO via Container "nextcloud-aio-apache" auf Port 11000)
# Wichtig: Der "nextcloud-aio-apache"-Container muss im selben Docker-Netz 'proxy' hängen.
# ---------------------------
server {
  listen 80;
  server_name ${NEXTCLOUD_HOST};

  client_max_body_size 10240M;  # große Uploads
  underscores_in_headers on;

  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Upstream zum von AIO erzeugten Apache-Container
    proxy_pass http://nextcloud-aio-apache:11000/;

    # Timeouts großzügig für große Uploads
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    send_timeout 86400;
  }
}

# ---------------------------
# n8n
# ---------------------------
server {
  listen 80;
  server_name ${N8N_HOST};

  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_pass http://n8n:5678/;
  }
}

# ---------------------------
# NocoDB
# ---------------------------
server {
  listen 80;
  server_name ${NOCODB_HOST};

  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass http://nocodb:${NOCODB_PORT}/;
  }
}

# ---------------------------
# Neo4j (HTTP UI) – nicht öffentlich im Internet empfehlen! Evtl. IP-Whitelist/Basic-Auth vorschalten.
# ---------------------------
server {
  listen 80;
  server_name ${NEO4J_HOST};

  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass http://neo4j:7474/;
  }
}

# ---------------------------
# Tesseract OCR (REST)
# ---------------------------
server {
  listen 80;
  server_name ${TESS_HOST};

  client_max_body_size 100M;

  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass http://tesseract:${TESS_PORT}/;
  }
}
