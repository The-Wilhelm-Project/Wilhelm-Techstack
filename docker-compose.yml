version: "3.9"

# networks:
#   proxy:
#     driver: bridge

services:
  # ---------------------------
  # Reverse Proxy (nginx)
  # ---------------------------
  # nginx:
  #   image: nginx:1.27-alpine
  #   container_name: reverse-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     # Für TLS später: - "443:443"
  #   volumes:
  #     - ./nginx/conf.d:/etc/nginx/conf.d:ro
  #     - nginx_conf:/etc/nginx
  #     - nginx_cache:/var/cache/nginx
  #   networks:
  #     - proxy
  #   depends_on:
  #     - nextcloud-aio-master
  #     - n8n
  #     - nocodb
  #     - neo4j
  #     - tesseract

  # ---------------------------
  # Nextcloud AIO (Master)
  # Hinweis: Der Master startet beim Setup weitere Container,
  # u.a. "nextcloud-aio-apache", den wir hinter nginx terminieren.
  # ---------------------------
  nextcloud-aio-master:
    image: nextcloud/all-in-one:latest
    container_name: nextcloud-aio-master
    restart: unless-stopped
    privileged: true
    # networks:
    #   - proxy
    ports:
      # Setup-UI (nur lokal bzw. geschützt nutzen)
      - "8080:8080"
    volumes:
      - nextcloud_aio_master_cont:/mnt/docker-aio-config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Optional: AIO dazu bringen, die erzeugten Container ins "proxy"-Netz zu hängen.
      # Falls das in deiner Version nicht automatisch klappt, siehe Schritt 4 unten.
      DOCKER_NETWORK: proxy
      APACHE_IP_BINDING: 0.0.0.0
      NEXTCLOUD_DATADIR: /mnt/docker-aio-config/data
  # separates benanntes Volume außerhalb der volumes:-Sektion oben (damit AIO es wie dokumentiert findet)

  # ---------------------------
  # n8n
  # ---------------------------
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    # networks:
    #   - proxy
    environment:
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_HOST=${N8N_HOST}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - WEBHOOK_URL=http://${N8N_HOST}
    volumes:
      - n8n_data:/home/node/.n8n
    expose:
      - "5678"

  # ---------------------------
  # NocoDB
  # ---------------------------
  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb
    restart: unless-stopped
    # networks:
    #   - proxy
    environment:
      - NC_PUBLIC_URL=http://${NOCODB_HOST}
    volumes:
      - nocodb_data:/usr/app/data
    expose:
      - "${NOCODB_PORT}"
    command: ["-p", "${NOCODB_PORT}"]

  # ---------------------------
  # Neo4j
  # ---------------------------
  neo4j:
    image: neo4j:5
    container_name: neo4j
    restart: unless-stopped
    # networks:
    #   - proxy
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASS}
      - NEO4J_server_memory_pagecache_size=1G
      - NEO4J_server_memory_heap_initial__size=1G
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4JLABS_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    expose:
      - "7474" # HTTP
      - "7687" # Bolt

  # ---------------------------
  # Tesseract (REST)
  # ---------------------------
  tesseract:
    image: tesseractshadow/tesseract4re:latest
    container_name: tesseract
    restart: unless-stopped
    # networks:
    #   - proxy
    expose:
      - "${TESS_PORT}"
    environment:
      - PORT=${TESS_PORT}
      # Standardmäßig Englisch; weitere Sprachen via volumes / env möglich

volumes:
  n8n_data:
  nocodb_data:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
  # nginx_conf:
  # nginx_cache:
  nextcloud_aio_master_cont:
